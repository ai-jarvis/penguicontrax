{% extends "base.html" %}
{% block head %}
    {{ super() }}
{% endblock %}
{% block body %}
    {{ super() }}
    <div id="nav" class="col-lg-2 col-md-2 col-sm-3 hidden-xs tagsinput">
        <div class="floater" data-spy="affix" data-offset-top="44">
            <div class="system" data-container="body" data-placement="right" data-trigger="manual"
                 data-html="true"
                 data-content="<p>Click some tags if you want to see only events with those topics.</p><p>If you click a tag again, it will exclude all events with that topic.</p><p>If you click a tag a third time, your filter will not care about that topic.</p><p>If you have no topics turned on, it will turn on all the tags, except those you excluded.</p>">
                <h6>
                    <button id="hidenav" class="btn btn-default btn-xs">
                        <i class="fa fa-compress"></i>
                    </button>
                    &nbsp;
                    Filter by topics&nbsp;
                    <button class="btn btn-xs btn-info info" data-toggle="button"><i
                            class="glyphicon glyphicon-info-sign"></i></button>
                </h6>
                <div id="tagfilter">
                    <div class="alert alert-info">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
<!--                             <div class="tagsinput">
                                <span class="smalllabel">User tags: </span>
                                <span id="usertagfilter"></span>
                            </div>
 -->        </div>
    </div>
    <div class="col-lg-10 col-md-10 col-sm-9 col-xs-12" id="report">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-2 col-sm-2 col-xs-12" style="margin-bottom:15px">
                        <div id="shownav">
                            <button id="shownavbtn" class="btn btn-default btn-xs active">
                                <i class="fa fa-expand"></i>
                            </button>
                            <i class="fa fa-tag"></i>
                        </div>
                        <button id="createeventbutton" class="btn btn-primary">Suggest an event</button>
                    </div>
                    <div class="col-md-3 col-md-offset-0 col-sm-4 col-sm-offset-1 col-xs-12" style="margin-bottom:15px">
                        <div id="submissionsearch" class="input-group ">
                            <input type="search" class="form-control col-xs-1" placeholder="Search submissions">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-search "></i></span>
                        </div>
                    </div>
                    <div class="col-md-7 col-sm-12 hidden-xs text-right legend">
                        <span>Legend:</span>
                        <span class="bs-callout suggested">Awaiting followup</span>
                        <span class="bs-callout followedup">Followed up</span>
                        <span class="bs-callout accepted">Accepted</span>
                        {% if user is not none and user.staff == 1 %}
                            <span class="bs-callout rejected">Rejected</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <p id="submission-info"
                           data-default="To filter results, use the filter control at left or type a search term above."
                           data-rejected="We regret that for various reasons, we canâ€™t use these event suggestions this year. Maybe next year! Also, some of them may be here in error, in which case bear with us while we fix it."
                                >
                        </p>
                    </div>
                </div>

                <!-- Modal dialog allowing the user to login. -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="modal fade" id="login_modal" tabindex="-1" role="dialog" aria-labelledby="login_modal_label" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                    <h4 class="modal-title" id="login_modal_label">Login Required</h4>
                                </div>
                                <div id="login_modal_body" class="modal-body"><!-- Use javascript to set this content. --></div>




                                <div class="row">
                                    <div class="col-md-1">&nbsp;</div>
                                    <div class="col-md-2">
                                        <a href="/login?provider=facebook">
                                            <i class="fa fa-facebook-square fa-3x"></i>
                                        </a>
                                    </div>
                                    <div class="col-md-2">
                                        <a href="/login?provider=twitter">
                                            <i class="fa fa-twitter-square fa-3x"></i>
                                        </a>
                                    </div>
                                    <div class="col-md-2">
                                        <a href="/login?provider=google">
                                            <span class="google-large">
                                                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                                    width="2.7em" height="2.7em" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                                                <g>
                                                <path d="M274.896,302.641c-0.381-0.3-0.771-0.588-1.15-0.894c-0.128-0.097-0.247-0.206-0.372-0.306
                                                    c-0.269-0.207-0.433-0.334-0.433-0.334h-11.047c-5.287,0.354-10.62,0.94-15.909,1.49c-6.234,0.736-12.434,1.717-18.592,2.728
                                                    c-3.077,0.524-6.149,1.045-9.19,1.667c-3.034,0.66-6.048,1.359-9.019,2.113c-5.285,1.396-10.614,3.66-15.651,6.359
                                                    c-5.066,2.664-9.761,6.066-13.854,9.9c-4.086,3.853-7.468,8.277-10.024,12.773c-1.283,2.245-2.362,4.516-3.248,6.742
                                                    c-0.453,1.111-0.813,2.232-1.152,3.335c-0.364,1.083-0.689,2.156-0.95,3.222c-0.956,4.309-1.508,8.232-1.551,12.269
                                                    c-0.083,2.01,0.027,4.057,0.192,6.166l0.034,0.396l0.008,0.101c0.026,0.192-0.008-0.03-0.021-0.121l0.036,0.272l0.154,1.176
                                                    l0.233,1.599c0.199,1.124,0.414,2.269,0.685,3.369c1.119,4.414,2.563,8.633,4.695,12.569c2.168,3.896,4.78,7.672,8.086,11.11
                                                    c3.314,3.408,7.148,6.669,11.54,9.478c8.759,5.676,19.424,9.824,30.777,12.416c5.688,1.245,11.554,2.157,17.51,2.709
                                                    c5.957,0.491,12,0.658,18.076,0.589c1.316-0.007,3.197-0.073,4.551-0.132c1.432-0.052,2.922-0.147,4.418-0.245
                                                    c2.631-0.189,5.244-0.482,7.847-0.84c39.806-5.948,61.017-39.603,54.483-63.556C320.31,339.691,283.792,309.699,274.896,302.641z"
                                                    />

                                                    <ellipse transform="matrix(-0.3087 -0.9512 0.9512 -0.3087 180.2603 423.0658)" cx="243.869" cy="146.028" rx="74.706" ry="55.638"/>
                                                <path d="M430.667,9H82.333C42,9,9,42,9,82.333v348.333C9,471,42,504,82.333,504h348.333C471,504,504,471,504,430.667V82.333
                                                    C504,42,471,9,430.667,9z M361.13,367.296c-0.214,1.101-0.407,2.195-0.674,3.277c-0.249,1.077-0.541,2.124-0.907,3.395
                                                    c-0.594,1.798-1.332,3.773-2.089,5.521c-6.302,14.05-15.371,25.479-25.958,34.99c-1.972,1.704-4.014,3.304-6.087,4.851
                                                    c-6.239,4.891-13.495,9.596-22.011,13.918c-47,23.865-106.771,13.523-106.771,13.523l0.003-0.023
                                                    c-4.954-0.679-9.952-1.667-14.969-3.037l0.021,0.033c0,0-4.565-0.974-11.414-3.843c-6.475-2.653-12.966-5.978-18.918-10.487
                                                    c-15.983-11.276-30.286-25.774-33.542-46.483c-1.838-11.683,0.406-23.63,2.707-31.826c1.445-5.852,3.745-11.459,6.727-16.445
                                                    c1.17-1.945,2.44-3.795,3.748-5.582c1.371-1.742,2.771-3.432,4.238-5.008c2.899-3.188,6.041-5.988,9.256-8.5
                                                    c3.218-2.51,6.524-4.725,9.876-6.693c3.384-1.93,6.632-3.844,10.026-5.43c6.727-3.235,13.352-6.078,20.16-8.398
                                                    c6.446-2.148,13.067-3.697,20.081-4.551c0.153-0.025,0.296-0.057,0.451-0.079c18.557-2.942,39.67-3.187,48.165-3.187
                                                    c0.781,0,1.494,0.031,2.208,0.063c-3.392-3.701-15.797-18.309-15.797-33.956c0-8.998,2.434-15.159,4.884-19.085
                                                    c-45.274,3.184-86.458-21.337-97.505-61.209c-12.883-46.483,20.067-96.19,73.595-111.026c9.539-2.644,19.085-3.979,28.41-4.162
                                                    v-0.044c0,0,18.444-0.405,25.886-1.106s38.184-19.522,41.097-21.787c2.911-2.265,5.5-1.456,5.5-1.456s12.135,9.868,13.104,11.811
                                                    c0.972,1.941-1.617,5.663-1.617,5.663S318.29,71.16,316.188,73.749c-2.104,2.589-0.811,6.341-0.811,6.341l-0.006,0.015
                                                    c9.626,8.098,17.297,18.177,22.229,29.856l0.014-0.022c0,0,8.792,18.125,8.82,40.904c0.031,23.055-14.553,41.823-33.482,56.384
                                                    s-25.887,26.858-25.887,34.624c0,19.208,10.841,19.579,32.032,36.874c0.077,0.064,0.144,0.121,0.222,0.185
                                                    c4.802,3.583,9.542,7.403,14.195,11.541c2.653,2.362,5.26,4.852,7.765,7.521c1.771,1.791,3.41,3.75,4.981,5.801
                                                    c0.106,0.127,0.174,0.215,0.174,0.215h-0.006c0.655,0.859,1.301,1.729,1.933,2.619c4.316,6.252,8.05,13.362,10.497,21.416
                                                    c1.85,6.108,2.944,12.707,3.341,19.446l0.003-0.005c0,0,0.062,0.721,0.085,1.989c0.057,1.483,0.093,2.971,0.081,4.463
                                                    C362.354,358.383,361.893,362.896,361.13,367.296z"/>
                                                </g>
                                                </svg>
                                            </span>
                                        </a>
                                    </div>
                                    <div class="col-md-5">
                                        <a href="/login?provider=yahoo">
                                            <span class="google-large">
                                                <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                                    width="2.7em" height="2.7em" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve">
                                                <path d="M430.167,8.5H81.833C41.5,8.5,8.5,41.5,8.5,81.833v348.333c0,40.334,33,73.334,73.333,73.334h348.333
                                                    c40.334,0,73.334-33,73.334-73.333V81.833C503.5,41.5,470.5,8.5,430.167,8.5z M343.558,369.397v22.096H138.937l6.244-20.175
                                                    c0,0,21.615,0,35.064,0c13.45,0,26.899-12.488,26.899-12.488v-68.207L87.349,151.327H27.5v-28.82h204.621v28.82h-66.286
                                                    l91.263,106.633l82.47-69.167h-48.847l-10.566-30.741h186.367l-24.977,30.741H407.59
                                                    c-42.171,14.647-131.277,103.752-131.277,103.752v76.854L343.558,369.397L343.558,369.397z M454.034,391.493h-31.702V358.83
                                                    l37.466,3.843L454.034,391.493z M459.798,342.499h-31.701V215.691l63.403,7.686L459.798,342.499z"/>
                                                </svg>
                                            </span>
                                        </a>
                                    </div>
                                </div>
                                <div class="modal-footer"></div>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>

                <div class="row submissions-list">
                    <div class="col-md-12">
                        <div id="submissions" class="row">
                            <div class="alert alert-info">
                                <p>Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12" style="text-align:right">
                    <button id="showRejected" class="btn btn-default btn-xs">
                        Show Rejected
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}html
{% block page_script %}
    {{ super() }}

    <!-- Use Flask-Assets to package and deliver static assets. See bundles defined in __init__.py -->
    {% assets filters="jsmin",output="build/submissions-%(version)s.js","tagFilter.js","submissionList.js","collapsetagnav.js" %}
        <script type="text/javascript" src="{{ ASSET_URL }}"></script>
    {% endassets %}

    <script type="text/javascript">

        $(document).ready(function () {
            var $info = $('#submission-info');

            $("[data-toggle=popover]").popover();
            $("[data-toggle=tooltip]").tooltip();

            $('.tagsinput').popover();

            //toggle the popover when clicking the info ball
            $(".tagsinput.system .info").on('click', function (ev) {
                $('.tagsinput.system').popover('toggle');
            });

            $("#createeventbutton").click(function () {
                document.location.href = "/eventform"
            });

            //set default info text
            $info.text($info.data('default'));

            ptrax.SubmissionSearch = can.Control.extend({
                "input input": _.debounce(function (el) {
                    var submissions = this.options.submissions;
                    var val = el.val();
                    var matches = 0;

                    can.batch.start();
                    if (!_.isEmpty(val) && val.length > 1) {
                        val = val.toLowerCase();
                        //get matches
                        _.forEach(submissions, function (submission) {
                            var search = submission.attr('search').attr();

                            var match = _.find(search, function (content) {
                                return content.indexOf(val) !== -1;
                            });

                            if (match) {
                                matches++;
                            }

                            submission.attr('hidden', !match);
                        });
                    } else {
                        _.forEach(submissions, function (submission) {
                            submission.attr('hidden', false);
                        });
                        matches = 0;
                    }
                    can.batch.stop();

                    if (matches) {
                        $info.text(matches + ' search results.');
                    } else {
                        $info.text($info.data('default'));
                    }
                }, 250)
            });

            var tagFilter = new ptrax.TagFilter("#tagfilter", {
                tpl: "{{ "js/tagfilter.mustache" | get_js_template }}",
                submissions : $.Deferred()
            });

            ptrax.model.Submissions.findAll().done(function (submissions) {
                var rejectedSubmissions;

                //add a search array for lookup with search function
                _.forEach(submissions, function (submission) {
                    var search = [];

                    search.push(submission.title.toLowerCase());
                    search.push(submission.description.toLowerCase());
                    search.push(submission.tags.join(" ").toLowerCase());
                    search.push(submission.submitter.name.toLowerCase());
                    search.push(submission.presenters.join(' ').toLowerCase());

                    submission.attr('search', search);
                });

                //add submissions
                tagFilter.options.submissions.resolve(submissions);

                new ptrax.SubmissionList("#submissions", {
                    submissionsTpl: "{{ "js/submissions.mustache" | get_js_template }}",
                    userLinkTpl: "{{ "js/user_link.mustache" | get_js_template }}",
                    presenterLinkTpl: "{{ "js/presenter_link.mustache" | get_js_template }}",
                    userTextTpl: "{{ "js/user_text.mustache" | get_js_template }}",
                    submissions: submissions
                });

                new ptrax.SubmissionSearch("#submissionsearch", {submissions: submissions});

                //in page bindings
                $('#showRejected').on('click', function () {
                    var $btn = $(this);
                    var active = $btn.hasClass('active');
                    var remove;
                    $btn.button('loading');

                    function showRejected() {
                        $btn.button('reset').button('toggle');
                        //set info text to rejected messaging
                        $info.text($info.data('rejected'));
                        //hide other submissions
                        can.batch.start();
                        _.forEach(submissions, function (submission) {
                            submission.attr('hidden', true);
                        });
                        can.batch.stop();
                        //add rejected submissions
                        submissions.push.apply(submissions, rejectedSubmissions);
                    }

                    if (active) {
                        //remove rejected events and return to normal messages
                        remove = _.filter(submissions, {"followUpState": 3});
                        can.batch.start();
                        _.forEach(remove, function (r) {
                            var idx = _.findIndex(submissions, {"id": r.id});
                            submissions.splice(idx, 1);
                        });

                        //show all submissions again
                        _.forEach(submissions, function (submission) {
                            submission.attr('hidden', false);
                        });

                        can.batch.stop();
                        $info.text($info.data('default'));
                        $btn.button('reset').button('toggle');

                    } else {
                        if (rejectedSubmissions) {
                            showRejected();
                        } else {
                            ptrax.model.RejectedSubmissions.findAll()
                                    .done(function (rejectedList) {
                                        rejectedSubmissions = rejectedList;
                                        showRejected();
                                    });
                        }
                    }

                });

            });

        });


    </script>
{% endblock %}
